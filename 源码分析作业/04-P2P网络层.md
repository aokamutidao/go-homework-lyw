# 04 - P2P 网络层与 Kademlia 协议

> 返回: [[Go-Ethereum 核心功能与架构设计研究作业]] | 上一章: [[02-核心模块交互]] | 下一章: [[05-区块链同步协议]]

## 4.1 P2P 网络层概述

Geth 的 P2P 网络层是整个以太坊网络的通信基础，负责节点发现、连接管理、消息路由等功能。

```
┌─────────────────────────────────────────────────────────────────┐
│                      P2P 网络层架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      Server                                │  │
│  │  - 生命周期管理                                            │  │
│  │  - 协议注册                                                │  │
│  │  - 监听器管理                                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                            │                                    │
│                            ▼                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    ProtocolManager                         │  │
│  │  - 协议握手                                                │  │
│  │  - 消息分发                                                │  │
│  │  - -Peer 管理                                             │  │
│  └───────────────────────────────────────────────────────────┘  │
│                            │                                    │
│          ┌─────────────────┼─────────────────┐                  │
│          ▼                 ▼                 ▼                  │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐           │
│  │  Discovery  │   │   Dialer    │   │   RLPx      │           │
│  │  (Kademlia) │   │   连接发起   │   │   加密传输   │           │
│  └─────────────┘   └─────────────┘   └─────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 4.2 Kademlia 协议实现

### Kademlia 简介

Kademlia 是一种分布式哈希表（DHT）协议，用于高效的节点发现和消息路由。

```
Kademlia 核心概念:

1. 节点 ID (Node ID)
   - 160 位哈希值
   - 用于计算节点距离

2. 距离度量
   - distance(a, b) = a XOR b
   - 异或距离满足三角不等式

3. K-Bucket
   - 每个节点维护 160 个桶
   - 第 i 个桶存储距离为 [2^i, 2^(i+1)) 的节点
   - 每个桶最多 K 个节点 (K=16)

4. 查找算法
   - 并行查询最近的 α 个节点 (α=3)
   - 迭代查找直到找到目标
```

### 节点距离示例

```
节点 A: 0011 (3)
节点 B: 0101 (5)
节点 C: 1010 (10)

距离计算:
distance(A, B) = 3 XOR 5 = 0110 = 6
distance(A, C) = 3 XOR 10 = 1001 = 9
distance(B, C) = 5 XOR 10 = 1111 = 15

A 和 B 更近，会被放在同一个 K-Bucket 中
```

### Geth 中的 Kademlia 实现

```go
// p2p/discover/table.go

// Table 管理 Kademlia 路由表
type Table struct {
    self       *Node           // 自身节点
    buckets    [bucketSize]*bucket  // 160 个桶
    db         *enr.DB         // ENR 数据库
    net        Transport       // 网络传输层
}

// bucket 管理一组节点
type bucket struct {
    // 按最近活动时间排序
    entries []*Node
}
```

### 节点发现流程

```
                    节点发现流程
    ┌─────────────────────────────────────────┐
    │                                         │
    │  1. 启动节点                            │
    │     - 生成节点 ID                       │
    │     - 加载已知节点 (bootnodes)          │
    │     - 初始化路由表                      │
    │                                         │
    │  2. Ping 消息                           │
    │     ─────────────────────────────►      │
    │     向已知节点发送 Ping                  │
    │                                         │
    │  3. Pong 响应                           │
    │     ◄──────────────────────────────     │
    │     对方返回 Pong (包含 ENR)             │
    │                                         │
    │  4. ENR 交换                            │
    │     ◄──────────────────────────────     │
    │     获取对方网络信息                     │
    │                                         │
    │  5. 路由表更新                          │
    │     - 更新 Ping 时间戳                  │
    │     - 调整 K-Bucket                     │
    │                                         │
    └─────────────────────────────────────────┘
```

## 4.3 核心源码分析

### Server 结构

```go
// p2p/server.go

type Server struct {
    // 网络配置
    PrivateKey *ecdsa.PrivateKey  // 私钥 (用于加密)

    // 监听配置
    ListenAddr string             // 监听地址
    ListenPort int                // 监听端口
    NAT       NAT                 // NAT 穿透

    // 节点发现
    BootstrapNodes []*Node        // 引导节点
    StaticNodes    []*Node        // 静态节点
    TrustedNodes   []*Node        // 信任节点

    // 协议管理
    Protocols []Protocol          // 注册的协议

    // 运行状态
    running bool
    quit    chan struct{}

    // 连接管理
    peerCh       chan *PeerEvent
    removePeerCh chan *Peer
}
```

### 连接建立流程

```go
// p2p/server.go

func (s *Server) run() {
    // 1. 启动监听
    s.startListening()

    // 2. 启动发现服务
    s.startDiscovery()

    // 3. 事件循环
    for {
        select {
        case <-s.quit:
            return
        case op := <-s.opQueue:
            op(s)
        }
    }
}
```

### RLPx 加密协议

RLPx 是以太坊的加密传输协议，基于迪菲-赫尔曼密钥交换：

```
RLPx 握手流程:

    Alice                              Bob
      │                                 │
      │  1. AuthMsg (加密的公钥)         │
      │ ─────────────────────────────►  │
      │                                 │
      │  2. AckMsg (确认)               │
      │ ◄─────────────────────────────  │
      │                                 │
      │  3. 加密通道建立                 │
      │ ◄═════════════════════════════► │
      │                                 │
      │  4. 发送协议消息                  │
      │ ─────────────────────────────►  │
```

## 4.4 协议消息处理

### 消息编码 (RLP)

```go
// rlp/encoder.go

type Encoder interface {
    EncodeRLP(w io.Writer) error
}

// 消息格式
type Msg struct {
    Code       uint64      // 消息类型
    Size       uint32      // 消息大小
    Payload    io.Reader   // 消息内容
}
```

### 协议注册

```go
// p2p/protocol.go

// Protocol 定义一个 P2P 协议
type Protocol struct {
    Name    string        // 协议名称
    Version uint          // 协议版本
    Length  uint64        // 消息数量

    // 协议消息处理
    Run func(p *Peer, rw MsgReadWriter) error

    // 节点信息
    NodeInfo func() interface{}

    // 协议描述
    Attributes []enr.Entry
}
```

## 4.5 网络拓扑

```
                    以太坊网络拓扑

    ┌─────────────────────────────────────────────────────────┐
    │                                                         │
    │    Bootnodes (引导节点)                                  │
    │         │                                               │
    │         ▼                                               │
    │    ┌─────────────────────────────────────┐             │
    │    │      全节点 (Full Node)              │             │
    │    │  - 同步完整区块数据                   │             │
    │    │  - 参与区块传播                       │             │
    │    │  - 可选: 挖矿                        │             │
    │    └─────────────────────────────────────┘             │
    │              │                    │                     │
    │    ┌─────────┴─────────┐  ┌──────┴──────┐              │
    │    ▼                   ▼  ▼             ▼              │
    │ ┌──────┐          ┌──────┐ ┌──────┐  ┌──────┐          │
    │ │归档节点│          │验证节点│ │轻节点│  │ RPC节点│      │
    │ │(Arch)│          │(Prune)│ │(Light)│  │(HTTP) │      │
    │ └──────┘          └──────┘ └──────┘  └──────┘          │
    │                                                         │
    └─────────────────────────────────────────────────────────┘
```

### 各类节点特点

| 节点类型 | 数据需求 | 存储大小 | 计算需求 | 网络需求 |
|---------|---------|---------|---------|---------|
| **全节点** | 完整链 + 状态 | ~1TB | 高 | 高 |
| **归档节点** | 完整链 + 完整状态 | >10TB | 高 | 高 |
| **轻节点** | 区块头 + 状态快照 | ~10GB | 低 | 中 |
| **RPC节点** | 通过 API 访问 | - | - | - |

## 4.6 常见问题和调试

### 查看连接状态

```javascript
// JavaScript 控制台
> admin.peers
// 显示所有连接的节点信息

> admin.nodeInfo
// 显示本节点信息

> net.listening
// 检查是否正在监听

> devp2p.serverInfo
// 显示 P2P 服务器状态
```

### 网络问题排查

```bash
# 检查节点连通性
geth --bootnodes enode://... --verbosity 4

# 查看 P2P 日志
grep -i p2p geth.log

# 检查端口监听
netstat -an | grep 30303
```

---

**下一步**: 继续阅读 [[05-区块链同步协议]] 了解区块同步机制
