# 02 - 核心模块交互关系分析

> 返回: [[Go-Ethereum 核心功能与架构设计研究作业]] | 上一章: [[01-Geth定位与生态]] | 下一章: [[03-分层架构图]]

## 2.1 模块总览

Geth 的核心模块可以划分为四个主要层次：

1. **P2P 网络层** - 节点发现与通信
2. **区块链协议层** - 同步与广播
3. **状态存储层** - 数据持久化
4. **EVM 执行层** - 智能合约执行

```
┌─────────────────────────────────────────────────────────────────┐
│                     Geth 核心模块架构                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    P2P 网络层 (p2p)                      │   │
│   │  Server → Dialer → ProtocolManager → Discovery          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                  区块链协议层 (eth/les)                   │   │
│   │  Syncer → Fetcher → Handler → Peer → Protocol           │   │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    核心层 (core)                         │   │
│   │  Blockchain → StateProcessor → TxPool → BlockChain      │   │
│   └─────────────────────────────────────────────────────────┘   │
│           │                        │                            │
│           ▼                        ▼                            │
│   ┌────────────────┐    ┌──────────────────────────┐           │
│   │ EVM执行层 (vm) │    │  状态存储 (trie/ethdb)    │           │
│   │ Interpreter    │    │  Trie → Database → Cache  │           │
│   └────────────────┘    └──────────────────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 2.2 区块链同步协议

### eth/62 和 eth/63 协议

eth/62 和 eth/63 是以太坊的两种不同版本的区块链同步协议：

| 版本 | 功能 | 说明 |
|------|------|------|
| **eth/62** | 区块同步 | 只同步区块头和区块体 |
| **eth/63** | 完整同步 | 包含状态同步（Account/Storage Trie） |

### 协议消息类型

```
eth/62 消息类型:
├── Status          - 握手连接状态
├── NewBlockHashes  - 新区块广播
├── Transactions    - 交易广播
├── GetBlockHeaders - 请求区块头
├── BlockHeaders    - 响应区块头
├── GetBlockBodies  - 请求区块体
├── BlockBodies     - 响应区块体
└── NewBlock        - 新区块传播

eth/63 新增消息:
├── GetNodeData     - 请求状态节点
├── NodeData        - 响应状态节点
├── GetReceipts     - 请求收据
└── Receipts        - 响应收据
```

### 同步流程

```
                    区块同步流程
    ┌─────────────────────────────────────────┐
    │                                         │
    │  1. 建立 P2P 连接                        │
    │     Client ──handshake──► Server        │
    │                                         │
    │  2. 交换状态信息                          │
    │     Status (td, hash, number)           │
    │                                         │
    │  3. 判断同步方向                          │
    │     if remote > local: 启动同步          │
    │                                         │
    │  4. 批量请求区块头                        │
    │     GetBlockHeaders (start, count)      │
    │     ◄── BlockHeaders                    │
    │                                         │
    │  5. 并行请求区块体                        │
    │     GetBlockBodies (hashes)             │
    │     ◄── BlockBodies                     │
    │                                         │
    │  6. 验证并插入区块                        │
    │     Validate → Write → Update TD         │
    │                                         │
    └─────────────────────────────────────────┘
```

## 2.3 交易池管理与 Gas 机制

### 交易池核心结构

```
                    交易池架构
    ┌─────────────────────────────────────────┐
    │               TxPool                     │
│  ├─────────────────────────────────────────┤
│  │  pending: 按账户排序的待执行交易          │
│  │  queue:   按nonce排序的排队交易           │
│  │  all:     所有交易集合                    │
│  └─────────────────────────────────────────┘
│                    │
│                    ▼
│  ┌─────────────────────────────────────────┐
│  │              PoolAnalyzer                │
│  │  - 重复检测                              │
│  │  - Gas 价格分析                          │
│  │  - 账户余额检查                          │
│  │  - nonce 序列验证                        │
│  └─────────────────────────────────────────┘
```

### Gas 机制详解

```
Gas 计算公式:
┌────────────────────────────────────────────────────────────┐
│  Gas = BaseFee + DataWordFee × 数据长度 +                  │
│        OpFee × 操作次数 + 存储操作费                        │
└────────────────────────────────────────────────────────────┘

典型交易 Gas 消耗:
├── 基础费用 (BaseFee):      21,000 Gas
├── 数据存储 (NonzeroByte):   16 Gas/byte
├── 数据存储 (ZeroByte):       4 Gas/byte
├── 合约创建:                 32,000 Gas 额外
└── EVM 操作:                各种指令不同
```

### 费用计算示例

```go
// core/types/transaction.go

// 计算交易 Gas 成本
func (tx *Transaction) Cost() *big.Int {
    return new(big.Int).Add(tx.GasPrice(), tx.Value())
}

// 计算执行费用
func (tx *Transaction) GasFeeCap() *big.Int {
    // EIP-1559: 最大费用上限
}

// 基础费用计算
func (tx *Transaction) Gas() uint64 {
    return 21000 + // 基础费用
           16*len(tx.Data()) + // 数据存储费用
           tx.GasLimitForContract() // 合约创建额外费用
}
```

## 2.4 EVM 执行环境构建

### EVM 执行流程

```
                    EVM 执行流程
    ┌─────────────────────────────────────────┐
    │  1. 创建 EVM 上下文                      │
    │     Context {                           │
    │       CanTransfer: 检查余额              │
    │       Transfer:     转账操作             │
    │       GetHash:      获取区块哈希         │
    │       Coinbase:     矿工地址             │
    │       GasLimit:     区块 Gas 上限        │
    │       BlockNumber:  区块高度             │
    │       Time:        时间戳                │
    │       Difficulty:  难度值                │
    │     }                                   │
    └───────────────────┬─────────────────────┘
                        │
                        ▼
    ┌─────────────────────────────────────────┐
    │  2. 加载合约账户状态                      │
    │     - 账户余额                           │
    │     - 合约代码                           │
    │     - 存储数据                           │
    └───────────────────┬─────────────────────┘
                        │
                        ▼
    ┌─────────────────────────────────────────┐
    │  3. 解释执行字节码                       │
    │     for {                                │
    │       op := code[pc]                    │
    │       switch op {                       │
    │         case ADD:       // 加法         │
    │         case SUB:       // 减法         │
    │         case CALL:      // 调用合约      │
    │         case CREATE:    // 创建合约      │
    │         // ... 更多指令                  │
    │       }                                 │
    │       pc++                              │
    │     }                                   │
    └───────────────────┬─────────────────────┘
                        │
                        ▼
    ┌─────────────────────────────────────────┐
    │  4. 更新状态                             │
    │     - 修改账户余额                       │
    │     - 修改存储数据                       │
    │     - 创建/删除合约                      │
    │     - 记录日志                           │
    └─────────────────────────────────────────┘
```

### 核心源码位置

| 功能 | 文件路径 |
|------|----------|
| EVM 主体 | `core/vm/evm.go` |
| 指令解释器 | `core/vm/instructions.go` |
| Gas 表 | `core/vm/gas_table.go` |
| 操作码定义 | `core/vm/opcodes.go` |

## 2.5 共识算法实现

### Ethash (PoW)

```
                    Ethash 工作流程
    ┌─────────────────────────────────────────┐
    │                                         │
    │  ┌─────────────────────────────────┐    │
    │  │        区块头 + Nonce            │    │
    │  └─────────────────────────────────┘    │
    │                    │                     │
    │                    ▼                     │
    │  ┌─────────────────────────────────┐    │
    │  │         Keccak256 哈希           │    │
    │  │         (混淆阶段)                │    │
    │  └─────────────────────────────────┘    │
    │                    │                     │
    │                    ▼                     │
    │  ┌─────────────────────────────────┐    │
    │  │      与目标难度比较               │    │
    │  │    hash < target × difficulty    │    │
    │  └─────────────────────────────────┘    │
    │                    │                     │
    │          ┌─────────┴─────────┐          │
    │          ▼                   ▼          │
    │     找到解 ✓              未找到 ─► 重试  │
    │                                         │
    └─────────────────────────────────────────┘

    Dagger-Hashimoto 算法特点:
    - 内存硬性 (Memory-hard)
    - ASIC 抵抗性
    - 验证轻量级
```

### PoS (Casper FFG)

```
                    PoS 共识流程
    ┌─────────────────────────────────────────┐
    │                                         │
    │  验证者 (Validator)                      │
    │  ├── 质押 32 ETH                        │
    │  ├── 运行验证节点                       │
    │  └── 获得投票权重                       │
    │                                         │
    │  区块生产                               │
    │  ├── 信标链区块 (每 12 秒)              │
    │  └── 执法阶段 (Justification/Finality)  │
    │                                         │
    │  最终确定性 (Finality)                   │
    │  ├── 超多数 checkpoint (2/3 验证者)     │
    │  └── 不可逆转                          │
    │                                         │
    └─────────────────────────────────────────┘
```

### 共识算法源码结构

| 组件 | 路径 |
|------|------|
| 共识接口 | `consensus/consensus.go` |
| Ethash 实现 | `consensus/ethash/consensus.go` |
| Clique (PoA) | `consensus/clique/clique.go` |
| Istanbul (PoA) | `consensus/istanbul/ Istanbul.go` |

## 2.6 模块协作时序图

```
    用户发起交易到区块上链的完整流程

    Client          TxPool         Blockchain        VM            Miner
      │               │               │               │              │
      │── tx ────────►│               │               │              │
      │               │── validate ──►│               │              │
      │               │◄── result ────│               │              │
      │               │               │               │              │
      │               │── add ───────►│               │              │
      │               │               │               │              │
      │               │◄─ pending ────│               │              │
      │               │               │               │              │
      │               │               │── assemble ─────────►│
      │               │               │               │     │
      │               │               │               │     │── get work
      │               │               │◄── work ──────│     │
      │               │               │               │     │
      │               │◄─ txs ────────┼───────────────┼─────│
      │               │               │               │     │
      │               │               │               │     │── seal
      │               │               │               │     │
      │               │               │               │     │── execute txs
      │               │               │               │◄────┤
      │               │               │               │     │
      │               │               │               │     │── validate
      │               │               │◄──────────────┼─────│
      │               │               │               │     │
      │               │               │── write block │     │
      │               │               │               │     │
      ◄── receipt ────┼───────────────┼───────────────┼─────┤
      │               │               │               │     │
```

---

**下一步**: 查看 03-分层架构图 可视化系统架构
