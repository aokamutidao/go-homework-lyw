# 05 - 区块链同步协议 (eth/62, eth/63)

> 返回: [[Go-Ethereum 核心功能与架构设计研究作业]] | 上一章: [[04-P2P网络层]] | 下一章: [[06-MPT状态存储]]

## 5.1 同步协议概述

以太坊的区块链同步协议经历了多个版本的演进，其中 **eth/62** 和 **eth/63** 是两个重要的里程碑。

```
协议版本演进:
├── eth/60-61 - 早期版本，基础区块同步
├── eth/62    - 引入快速同步的区块头/区块体分离
├── eth/63    - 新增状态同步 (GetNodeData/NodeData)
├── eth/64    - 支持 EIP-8 握手格式
└── eth/65    - 引入高效的状态广播 (GetNodeData 优化)
```

## 5.2 eth/62 协议详解

### 消息类型

```
eth/62 消息总览:

0x00 - Status            - 连接状态交换
0x01 - NewBlockHashes    - 新区块哈希广播
0x02 - Transactions      - 交易广播
0x03 - GetBlockHeaders   - 请求区块头
0x04 - BlockHeaders      - 响应区块头
0x05 - GetBlockBodies    - 请求区块体
0x06 - BlockBodies       - 响应区块体
0x07 - NewBlock          - 新区块传播
```

### Status 消息

```go
// eth/protocol.go

type StatusMsg struct {
    ProtocolVersion uint32    // 协议版本 (62)
    NetworkID       uint64    // 网络 ID (主网=1)
    TD              *big.Int  // 总难度 (Total Difficulty)
    CurrentBlock    common.Hash // 当前最佳区块哈希
    GenesisBlock    common.Hash // 创世区块哈希
}
```

### 区块头同步

```
                    GetBlockHeaders 请求

    请求格式:
    {
        "hashOrNumber": BlockNumber | BlockHash,
        "amount":       uint64,      // 请求数量
        "skip":         uint64,      // 跳过的数量
        "reverse":      bool         // 方向 (0=正向, 1=反向)
    }

    响应格式:
    BlockHeaders []*types.Header

    示例:
    - 获取从高度 100 开始的 10 个区块头
      { hashOrNumber: 100, amount: 10, skip: 0, reverse: 0 }

    - 获取从哈希 0xabc... 开始的 5 个区块头
      { hashOrNumber: 0xabc..., amount: 5, skip: 0, reverse: 0 }
```

### 区块体同步

```
                    GetBlockBodies 请求

    请求格式:
    GetBlockBodies []common.Hash  // 区块哈希列表

    响应格式:
    BlockBodies []BlockBody

    BlockBody 结构:
    {
        "transactions": TransactionList,
        "uncles":       UncleHeaders
    }
```

## 5.3 eth/63 协议详解

eth/63 在 eth/62 基础上新增了状态同步功能。

### 新增消息

```
eth/63 新增消息:

0x0d - GetNodeData    - 请求状态节点 (MPT 节点)
0x0e - NodeData       - 响应状态节点
0x0f - GetReceipts    - 请求交易收据
0x10 - Receipts       - 响应交易收据
```

### 状态同步流程

```
                    完整同步流程
    ┌─────────────────────────────────────────────┐
    │                                              │
    │  Phase 1: 区块头同步                          │
    │  ───────────────────────                     │
    │  1. 发送 GetBlockHeaders                     │
    │  2. 接收 BlockHeaders                        │
    │  3. 验证区块头有效性                          │
    │  4. 重复直到同步完成                          │
    │                                              │
    │  Phase 2: 区块体同步                          │
    │  ───────────────────────                     │
    │  1. 并行请求 BlockBodies                     │
    │  2. 组装完整区块                             │
    │  3. 验证并写入区块链                          │
    │                                              │
    │  Phase 3: 状态同步 (eth/63)                  │
    │  ───────────────────────                     │
    │  1. 构建 StateTrie                           │
    │  2. 发送 GetNodeData                         │
    │  3. 接收 NodeData                            │
    │  4. 重建状态树                               │
    │                                              │
    │  Phase 4: 收据同步                           │
    │  ───────────────────────                     │
    │  1. 发送 GetReceipts                         │
    │  2. 接收 Receipts                            │
    │  3. 存储收据                                 │
    │                                              │
    └─────────────────────────────────────────────┘
```

## 5.4 同步模式

### 全同步 (Full Sync)

```
全同步特点:
├── 接收所有区块
├── 执行所有交易
├── 验证所有状态
├── 存储完整链数据
└── 时间: 数小时到数天

流程:
启动 → 区块头同步 → 区块体下载 → 状态验证 → 收据同步 → 完成
```

### 快速同步 (Fast Sync)

```
快速同步特点:
├── 下载区块头和区块体
├── 下载最新状态 (而非全部)
├── 不执行历史交易
└── 时间: 约 1-2 小时

流程:
启动 → 区块头同步 → 区块体下载 → 状态根下载 → Pivot 点切换 → 完成
```

### 轻节点同步 (Light Sync)

```
轻节点同步特点:
├── 只下载区块头
├── 按需请求状态
├── 验证区块头工作量
└── 时间: 分钟级别

使用 LES 协议
```

## 5.5 核心源码分析

### Syncer 结构

```go
// eth/sync.go

type Syncer struct {
    chain     *core.BlockChain
    peerSet   *peerSet
    handler   *Handler

    // 同步状态
    mode      SyncMode
    fastSync  FastSync

    // 通道
    newPeerCh chan peer
    doneCh    chan struct{}
    quitCh    chan struct{}
}
```

### 同步状态机

```go
// eth/sync.go

func (s *Syncer) sync() {
    // 1. 等待至少一个对等节点
    for {
        select {
        case p := <-s.newPeerCh:
            if s.synchronize(p) {
                return
            }
        case <-s.quitCh:
            return
        }
    }
}

func (s *Syncer) synchronize(p *peer) error {
    // 检查本地高度
    if s.chain.CurrentHeader().Number.Uint64() >= p.head.Number.Uint64() {
        return nil // 无需同步
    }

    // 选择同步模式
    switch s.mode {
    case FullSync:
        return s.fullSync(p)
    case FastSync:
        return s.fastSync(p)
    case LightSync:
        return s.lightSync(p)
    }
}
```

### 区块下载器

```go
// eth/downloader/downloader.go

type Downloader struct {
    mode      SyncMode
    peers     *peerSet

    // 队列
    headerQueue   *queue
    bodyQueue     *queue
    receiptQueue  *queue
    stateQueue    *queue

    // 状态
    td              *big.Int
    currentBlock    common.Hash
}
```

## 5.6 区块传播机制

### 区块传播流程

```
                    区块传播流程
    ┌─────────────────────────────────────────────┐
    │                                              │
    │  矿工 (Miner)                                │
    │  ├── 1. 挖到新区块                           │
    │  ├── 2. 验证区块                             │
    │  └── 3. 广播区块 (NewBlock/NewBlockHashes)   │
    │         │                                   │
    │         ▼                                   │
    │  对等节点 (Peers)                            │
    │  ├── 4. 接收区块                             │
    │  ├── 5. 验证区块                             │
    │  ├── 6. 传播给其他节点                       │
    │  └── 7. 更新本地区块链                       │
    │                                              │
    └─────────────────────────────────────────────┘
```

### 传播优化

```
传播优化策略:

1. 首次传播 (NewBlockHashes)
   └── 只发送区块哈希，不发送完整区块

2. 按需请求 (GetBlockBodies)
   └── 收到哈希后，按需请求区块体

3. 区块传播限制
   └── 限制同时传播的区块数量

4. 对等节点选择
   └── 选择高质量对等节点优先传播
```

## 5.7 常见问题和调试

### 查看同步状态

```javascript
// JavaScript 控制台
> eth.syncing
// 返回同步状态或 false

> eth.blockNumber
// 当前本地区块高度

> admin.peers[0].sync
// 查看对等节点同步状态
```

### 同步问题排查

```bash
# 检查同步日志
geth --verbosity 4 2>&1 | grep -i "sync"

# 检查对等节点
geth attach --exec "admin.peers.length"

# 重置同步
geth removedb
geth --syncmode=fast
```

---

**下一步**: 继续阅读 [[06-MPT状态存储]] 了解状态存储机制
